# 不需要第三方服务器的NAT穿透

>*作者：Arvin 日期：2017年10月24日*

-----------------------------------

>BEGIN


1. 随便挑一个死的IP地址（在这里我们用59.66.1.1，ping之无回应即可）

2. 服务器端每隔一段时间对59.66.1.1发送一个ICMP echo request（ping），当然，什么都不会发生，因为不会有回应

3. 客户端向服务器端发送ICMP time exceed包，把自己假装成是服务器端与59.66.1.1之间的一个节点，告诉服务器端你发送的ping超时了（就想traceroute的原理），当然，这个包会被服务器端的NAT/防火墙通过并转发给它

4. 现在，服务器端知道客户端的外网地址了（而且客户端本来就知道服务器端的外网地址）

5. 服务器端使用某个端口（随便选一个吧，12345）向客户端的某个端口（比如23456）发送UDP包，当然，这个包会被客户端的NAT/防火墙拒绝

6. 客户端也同时使用端口23456向服务器端12345端口发送UDP包，而这个包会被服务器端的NAT/防火墙通过并转发！因为它会认为这是之前服务器发出的包的回应

7. 好了，服务器现在再发一个UDP包的话，同理也会被客户端的NAT/防火墙通过并转发

NAT不限制内网到外网的请求，接收内网请求后的外网到内网的数据包，限制记录的外网到内网的数据包。NAT穿透的关键是内网先请求外网ip（肯定被拒），对应的外网ip机器再向内网机器发送数据包，就能穿透内网的NAT（满足NAT的第二条规则）。其实就是ip数据包伪装。

>END